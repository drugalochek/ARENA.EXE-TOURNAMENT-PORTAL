<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ARENA.EXE | TOURNAMENT PORTAL</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://yastatic.net/taxi-widget/ya-taxi-widget-v2.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, set, update, get, push, onValue, off, remove, increment, limitToLast, query, orderByChild, equalTo, onChildAdded, onDisconnect } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8MSUPeyub8QqwRngEnAAsU61V_BP1GiY",
      authDomain: "arenaexetournaments.firebaseapp.com",
      databaseURL: "https://arenaexetournaments-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "arenaexetournaments",
      storageBucket: "arenaexetournaments.firebasestorage.app",
      messagingSenderId: "679117320575",
      appId: "1:679117320575:web:3d9017524935ca2913aa4a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    setPersistence(auth, browserLocalPersistence);

    const notifSound = new Audio('jg-032316-sfx-8-bit-score-1.mp3');
    const errorSound = new Audio('jg-032316-sfx-8-bit-crash-2.mp3'); 
    notifSound.volume = 0.5;

    let siteInterval = null;
    let currentDmId = null;
    let isInitialLoad = true;
    let editingLinkId = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let editingTourneyId = null;
    
    // Для отслеживания онлайна
    let onlineUsers = {};

    const msgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`;

    window.lang = localStorage.getItem('arena_lang') || 'en';
    const i18n = {
      en: {
        discover: "DISCOVER", create: "CREATE", profile: "PROFILE", exr: "EXR", hours: "ONLINE", 
        friends: "FRIENDS", vacant: "VACANT", connect: "CONNECT", delete_event: "DELETE EVENT", 
        message: "MESSAGE...", nickname: "NICKNAME", password: "PASSWORD", login: "LOG IN", join: "JOIN",
        change_name: "CHANGE NAME", save: "SAVE", cancel: "CANCEL", social_link: "SOCIAL LINK", label: "LABEL (DISCORD)",
        create_event: "CREATE EVENT", name: "NAME", format: "FORMAT", prize: "PRIZE", date: "DATE", 
        match_link: "MATCH LINK", desc: "DESC", upload: "UPLOAD", publish: "PUBLISH", close: "CLOSE",
        add_link: "ADD LINK", pro_service: "PRO ACCESS SERVICE", become_admin: "BECOME ADMINISTRATOR",
        admin_desc: "Get moderation rights, create tournaments and manage the ARENA.EXE community.",
        contact_owner: "CONTACT OWNER", disconnect: "DISCONNECT", sber: "SBERBANK — 50₽", support: "SUPPORT",
        android_title: "ARENA.EXE", android_desc: "Tournaments always at hand. Only for Android devices.",
        download_apk: "DOWNLOAD", yandex_title: "Yandex Food", yandex_sub: "Become a courier",
        yandex_desc: "Flexible schedule, daily payments and free uniform.", yandex_apply: "APPLY NOW",
        copied: "COPIED: ", not_found: "USER NOT FOUND", invalid_code: "INVALID CODE", entry_closed: "ENTRY CLOSED",
        team_full: "TEAM FULL", already_in: "ALREADY IN MATCH", joined: "JOINED ", leave_team_q: "LEAVE TEAM?",
        left_team: "LEFT TEAM", delete_q: "DELETE THIS TOURNAMENT?", event_terminated: "EVENT TERMINATED",
        delete_link_q: "DELETE LINK?", link_removed: "LINK REMOVED", friend_req: "NEW FRIEND REQUEST", 
        msg_notif: "NEW MESSAGE", friend_rem_q: "REMOVE FRIEND?", ban_q: " BAN THIS PLAYER?", 
        unban_q: " UNBAN THIS PLAYER?", status_updated: "STATUS UPDATED", name_updated: "NAME UPDATED", 
        link_saved: "LINK SAVED", fill_fields: "FILL ALL FIELDS", event_created: "EVENT CREATED: ", 
        cannot_ban_self: "CANNOT BAN SELF", reg_err: "REG ERROR", access_denied: "ACCESS DENIED",
        terminated_sub: "BANNED", founder_sub: "FOUNDER / CEO", elite_sub: "ELITE ADMIN", 
        admin_sub: "ADMINISTRATOR", pro_sub: "PRO PLAYER", player_sub: "PLAYER", copy: "COPY",
        add_friend: "ADD FRIEND", sent: "SENT", accept: "ACCEPT", chat: "CHAT", by: "BY", back: "BACK",
        del_msg: "DELETE MESSAGE?", file: "FILE", 
        security_check: "SECURITY CHECK", link_preview: "VERIFY THE DESTINATION LINK",
        finish_match: "FINISH MATCH", choose_winner: "CHOOSE WINNER: ALPHA OR OMEGA?", match_finished: "MATCH FINISHED! TEAM WINS!",
        wins: "WINS", losses: "LOSSES", to_next: "TO NEXT", online: "ONLINE", offline: "OFFLINE"
      },
      ru: {
        discover: "ОБЗОР", create: "СОЗДАТЬ", profile: "ПРОФИЛЬ", exr: "EXR", hours: "ОНЛАЙН", 
        friends: "ДРУЗЬЯ", vacant: "СВОБОДНО", connect: "ПОДКЛЮЧИТЬСЯ", delete_event: "УДАЛИТЬ СОБЫТИЕ", 
        message: "СООБЩЕНИЕ...", nickname: "НИКНЕЙМ", password: "ПАРОЛЬ", login: "ВХОД", join: "РЕГИСТРАЦИЯ",
        change_name: "ИЗМЕНИТЬ ИМЯ", save: "СОХРАНИТЬ", cancel: "ОТМЕНА", social_link: "СОЦ. СЕТЬ", label: "НАЗВАНИЕ (DISCORD)",
        create_event: "СОЗДАТЬ ТУРНИР", name: "НАЗВАНИЕ", format: "ФОРМАТ", prize: "ПРИЗ", date: "ДАТА", 
        match_link: "ССЫЛКА НА МАТЧ", desc: "ОПИСАНИЕ", upload: "ЗАГРУЗИТЬ", publish: "ОПУБЛИКОВАТЬ", close: "ЗАКРЫТЬ",
        add_link: "ДОБАВИТЬ ССЫЛКУ", pro_service: "PRO ДОСТУП", become_admin: "СТАТЬ АДМИНИСТРАТОРОМ",
        admin_desc: "Права модерации, создание турниров и управление сообществом ARENA.EXE.",
        contact_owner: "СВЯЗАТЬСЯ", disconnect: "ОТКЛЮЧИТЬСЯ", sber: "СБЕРБАНК — 50₽", support: "ПОДДЕРЖКА",
        android_title: "ARENA.EXE", android_desc: "Турниры всегда под рукой. Только для Android устройств.",
        download_apk: "СКАЧАТЬ EXE", yandex_title: "Яндекс Еда", yandex_sub: "Стань курьером",
        yandex_desc: "Гибкий график, ежедневные выплаты и форма в подарок.", yandex_apply: "ПОДАТЬ ЗАЯВКУ",
        copied: "СКОПИРОВАНО: ", not_found: "ИГРОК НЕ НАЙДЕН", invalid_code: "НЕВЕРНЫЙ КОД", entry_closed: "РЕГИСТРАЦИЯ ЗАКРЫТА",
        team_full: "КОМАНДА ПОЛНА", already_in: "УЖЕ В МАТЧЕ", joined: "ВСТУПИЛ В ", leave_team_q: "ПОКИНУТЬ КОМАНДУ?",
        left_team: "ВЫШЕЛ ИЗ КОМАНДЫ", delete_q: "УДАЛИТЬ ЭТОТ ТУРНИР?", event_terminated: "СОБЫТИЕ УДАЛЕНО",
        delete_link_q: "УДАЛИТЬ ССЫЛКУ?", link_removed: "ССЫЛКА УДАЛЕНА", friend_req: "НОВЫЙ ЗАПРОС В ДРУЗЬЯ", 
        msg_notif: "НОВОЕ СООБЩЕНИЕ", friend_rem_q: "УДАЛИТЬ ИЗ ДРУЗЕЙ?", ban_q: " ЗАБАНИТЬ ИГРОКА?", 
        unban_q: " РАЗБАНИТЬ ИГРОКА?", status_updated: "СТАТУС ОБНОВЛЕН", name_updated: "ИМЯ ОБНОВЛЕНО", 
        link_saved: "LINK SAVED", fill_fields: "ЗАПОЛНИТЕ ВСЕ ПОЛЯ", event_created: "СОБЫТИЕ СОЗДАНО: ", 
        cannot_ban_self: "НЕЛЬЗЯ БАНИТЬ СЕБЯ", reg_err: "ОШИБКА РЕГ.", access_denied: "ОТКАЗАНО В ДОСТУПЕ",
        terminated_sub: "ЗАБЛОКИРОВАН", founder_sub: "ОСНОВАТЕЛЬ / CEO", elite_sub: "ELITE АДМИН", 
        admin_sub: "АДМИНИСТРАТОР", pro_sub: "PRO ИГРОК", player_sub: "ИГРОК", copy: "КОПИР.",
        add_friend: "В ДРУЗЬЯ", sent: "ОТПРАВЛЕНО", accept: "ПРИНЯТЬ", chat: "ЧАТ", by: "ОТ", back: "НАЗАД",
        del_msg: "УДАЛИТЬ СООБЩЕНИЕ?", file: "ФАЙЛ",
        security_check: "ПРОВЕРКА БЕЗОПАСНОСТИ", link_preview: "ПРОВЕРЬТЕ ССЫЛКУ ПЕРЕД ПЕРЕХОДОМ",
        finish_match: "ЗАВЕРШИТЬ МАТЧ", choose_winner: "ВЫБЕРИТЕ ПОБЕДИТЕЛЯ: ALPHA ИЛИ OMEGA?", match_finished: "МАТЧ ЗАВЕРШЕН! КОМАНДА ПОБЕДИЛА!",
        wins: "ПОБЕД", losses: "ПОРАЖ", to_next: "ДО СЛЕД", online: "В СЕТИ", offline: "НЕ В СЕТИ"
      }
    };

    // Конфигурация уровней EXR
    const EXR_LEVELS = [
      { level: 1, name: "NV", min: 0, max: 500, label: "НОВИЧОК", labelEn: "NOVICE" },
      { level: 2, name: "PR", min: 501, max: 750, label: "ПРОФИ", labelEn: "PRO" },
      { level: 3, name: "EX", min: 751, max: 900, label: "ЭКСПЕРТ", labelEn: "EXPERT" },
      { level: 4, name: "VG", min: 901, max: 1050, label: "ВЕТЕРАН", labelEn: "VETERAN" },
      { level: 5, name: "EL", min: 1051, max: 1200, label: "ЭЛИТА", labelEn: "ELITE" },
      { level: 6, name: "LG", min: 1201, max: 1300, label: "ЛЕГЕНДА", labelEn: "LEGEND" },
      { level: 7, name: "IM", min: 1301, max: 1530, label: "ИММОРТАЛ", labelEn: "IMMORTAL" },
      { level: 8, name: "GD", min: 1531, max: 1750, label: "ГРАНД", labelEn: "GRAND" },
      { level: 9, name: "HM", min: 1751, max: 2000, label: "ХАРД", labelEn: "HARD" },
      { level: 10, name: "ULT", min: 2001, max: Infinity, label: "УЛЬТРА", labelEn: "ULTRA" }
    ];

    window.t = (key) => i18n[window.lang][key] || key;

    window.toggleLang = () => {
      window.lang = window.lang === 'en' ? 'ru' : 'en';
      localStorage.setItem('arena_lang', window.lang);
      location.reload();
    };

    window.core = {
      u: null, userData: null, currentTid: null, tempCover: "",

      // Функции для работы с EXR
      getExrLevel(exr) {
        for (const l of EXR_LEVELS) {
          if (exr >= l.min && exr <= l.max) {
            return l;
          }
        }
        return EXR_LEVELS[0];
      },

      getExrProgress(exr) {
        const level = this.getExrLevel(exr);
        if (level.level === 10) return 100;
        const range = level.max - level.min;
        const progress = ((exr - level.min) / range) * 100;
        return Math.min(100, Math.max(0, Math.floor(progress)));
      },

      getExrNext(exr) {
        const level = this.getExrLevel(exr);
        if (level.level === 10) return 0;
        return level.max - exr;
      },

      getExrLevelName(level) {
        return window.lang === 'ru' ? level.label : level.labelEn;
      },

      renderExrIcon(level, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const points = Math.min(level, 10);
        const width = 80;
        const height = 50;
        
        let path = "";
        let circles = "";
        
        for (let i = 0; i < points; i++) {
          const x = 10 + (i * 14);
          const y = 35 - (i % 2 === 0 ? 15 : 5);
          if (i === 0) path += `M${x},${y}`;
          else path += ` L${x},${y}`;
          circles += `<circle cx="${x}" cy="${y}" r="${4 + i}" fill="currentColor"/>`;
        }
        
        container.innerHTML = `
          <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" class="text-blue-500" style="filter: drop-shadow(0 0 10px currentColor);">
            <path d="${path}" stroke="currentColor" stroke-width="3" fill="none" opacity="0.5"/>
            ${circles}
          </svg>
        `;
      },

      // Функция для проверки онлайн статуса
      isUserOnline(uid) {
        return onlineUsers[uid] === true;
      },

      show(id, targetUid = null) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        const el = document.getElementById('section-' + id);
        if(el) el.classList.remove('hidden');
        if (id === 'home') this.loadList();
        if (id === 'profile') this.renderProfile(targetUid || this.u.uid);
        window.scrollTo(0,0);
      },

      notify(txt, type = 'success') {
        if (type === 'err') errorSound.play().catch(() => {});
        else notifSound.play().catch(() => {});
        const container = document.getElementById('notif-container');
        const n = document.createElement('div');
        n.className = `p-5 mb-3 rounded-[1.5rem] font-black text-[10px] tracking-widest uppercase border backdrop-blur-md animate-slide ${type === 'err' ? 'bg-red-600/20 border-red-500/50 text-red-500' : 'bg-blue-600/20 border-blue-500/50 text-blue-400'}`;
        n.innerText = txt;
        container.appendChild(n);
        setTimeout(() => { n.style.opacity = '0'; setTimeout(() => n.remove(), 500); }, 3000);
      },

      async copyId(text) {
        try {
          await navigator.clipboard.writeText(text);
          this.notify(window.t('copied') + text);
        } catch (err) {
          const input = document.createElement('input');
          input.value = text;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          this.notify(window.t('copied') + text);
        }
      },

      async ask(txt) {
        return new Promise((res) => {
          const m = document.getElementById('confirm-modal');
          document.getElementById('confirm-text').innerText = txt.toUpperCase();
          document.getElementById('confirm-yes').classList.remove('hidden');
          document.getElementById('confirm-no').classList.remove('hidden');
          document.getElementById('confirm-cancel').classList.add('hidden');
          
          document.getElementById('confirm-yes').innerText = window.lang === 'ru' ? 'ДА' : 'YES';
          document.getElementById('confirm-no').innerText = window.lang === 'ru' ? 'НЕТ' : 'NO';
          m.classList.remove('hidden');
          document.getElementById('confirm-yes').onclick = () => { m.classList.add('hidden'); res(true); };
          document.getElementById('confirm-no').onclick = () => { m.classList.add('hidden'); res(false); };
        });
      },

      async askWinner() {
        return new Promise((res) => {
          const m = document.getElementById('confirm-modal');
          document.getElementById('confirm-text').innerText = window.t('choose_winner');
          document.getElementById('confirm-yes').classList.remove('hidden');
          document.getElementById('confirm-no').classList.remove('hidden');
          document.getElementById('confirm-cancel').classList.remove('hidden');
          
          document.getElementById('confirm-yes').innerText = 'ALPHA';
          document.getElementById('confirm-no').innerText = 'OMEGA';
          document.getElementById('confirm-cancel').innerText = window.lang === 'ru' ? 'ОТМЕНА' : 'CANCEL';
          
          m.classList.remove('hidden');
          document.getElementById('confirm-yes').onclick = () => { m.classList.add('hidden'); res('alpha'); };
          document.getElementById('confirm-no').onclick = () => { m.classList.add('hidden'); res('omega'); };
          document.getElementById('confirm-cancel').onclick = () => { m.classList.add('hidden'); res(null); };
        });
      },

      getUserStyle(d) {
        if (d?.isBan) return { class: "text-red-600 opacity-50", sub: window.t('terminated_sub') };
        if (d?.isMaker) return { class: "txt-maker", sub: window.t('founder_sub') };
        if (d?.isAdmin && d?.isPro) return { class: "txt-elite", sub: window.t('elite_sub') };
        if (d?.isAdmin) return { class: "txt-admin", sub: window.t('admin_sub') };
        if (d?.isPro) return { class: "txt-pro", sub: window.t('pro_sub') };
        return { class: "text-white/80", sub: window.t('player_sub') };
      },

      formatHours(mins) { return Math.floor(Math.max(0, mins || 0) / 60) + "H"; },

      openEditName() {
        document.getElementById('edit-name-in').value = this.userData.name;
        document.getElementById('name-modal').classList.remove('hidden');
      },
      async saveName() {
        const n = document.getElementById('edit-name-in').value.trim();
        if(n) {
          await update(ref(db, `users/${this.u.uid}`), { name: n.toUpperCase() });
          this.notify(window.t('name_updated'));
          document.getElementById('name-modal').classList.add('hidden');
        }
      },

      openLinkEdit(id = null, label = '', url = '') {
        editingLinkId = id;
        document.getElementById('link-label-in').value = label;
        document.getElementById('link-url-in').value = url;
        document.getElementById('link-modal').classList.remove('hidden');
      },
      async saveLink() {
        const l = document.getElementById('link-label-in').value.trim();
        const u = document.getElementById('link-url-in').value.trim();
        if(l && u) {
          const id = editingLinkId || push(ref(db, `users/${this.u.uid}/socials`)).key;
          await update(ref(db, `users/${this.u.uid}/socials/${id}`), { label: l.toUpperCase(), url: u });
          this.notify(window.t('link_saved'));
          document.getElementById('link-modal').classList.add('hidden');
        }
      },

      async findUser() {
        const val = document.getElementById('user-search-in').value.trim();
        if(!val) return;
        const directSnap = await get(ref(db, `users/${val}`));
        if(directSnap.exists()) { this.showMini(val); return; }
        const q = query(ref(db, 'users'), orderByChild('name'), equalTo(val.toUpperCase()));
        const s = await get(q);
        if(s.exists()) {
           const uid = Object.keys(s.val())[0];
           this.showMini(uid);
        } else {
           this.notify(window.t('not_found'), "err");
        }
      },

      async findByCode() {
        const code = document.getElementById('search-in').value.toUpperCase().trim();
        if(!code) return;
        const q = query(ref(db, 'tourneys'), orderByChild('code'), equalTo(code));
        const s = await get(q);
        if(s.exists()) {
          const tid = Object.keys(s.val())[0];
          this.openLobby(tid);
        } else {
          this.notify(window.t('invalid_code'), "err");
        }
      },

      async join(side) {
        const tSnap = await get(ref(db, `tourneys/${this.currentTid}`));
        const t = tSnap.val();
        if(t.status !== 'open') return this.notify(window.t('entry_closed'), "err");
        const parts = t.format.split(/v|vs/i).map(s => parseInt(s.trim()));
        const limit = side === 'alpha' ? parts[0] : parts[1];
        if((t[side] ? Object.keys(t[side]).length : 0) >= limit) return this.notify(window.t('team_full'), "err");
        if((t.alpha && t.alpha[this.u.uid]) || (t.omega && t.omega[this.u.uid])) return this.notify(window.t('already_in'), "err");
        await update(ref(db, `tourneys/${this.currentTid}/${side}`), { [this.u.uid]: this.userData.name });
        this.notify(window.t('joined') + side.toUpperCase());
      },

      async leaveTeam(side) {
        if(await this.ask(window.t('leave_team_q'))) {
          await remove(ref(db, `tourneys/${this.currentTid}/${side}/${this.u.uid}`));
          this.notify(window.t('left_team'), "err");
        }
      },

      async deleteTourney(tid) {
        if(await this.ask(window.t('delete_q'))) {
          await remove(ref(db, `tourneys/${tid}`));
          await remove(ref(db, `chats/${tid}`));
          this.show('home');
          this.notify(window.t('event_terminated'), "err");
        }
      },

      async deleteLink(id) {
        if(await this.ask(window.t('delete_link_q'))) {
          await remove(ref(db, `users/${this.u.uid}/socials/${id}`));
          this.notify(window.t('link_removed'), "err");
        }
      },

      initGlobalListeners() {
        onChildAdded(ref(db, `friends/${this.u.uid}`), (snap) => {
          if (!isInitialLoad && snap.val() === 'pending_in') this.notify(window.t('friend_req'));
        });
        onChildAdded(ref(db, `direct_messages`), (snap) => {
          const chatId = snap.key;
          if (chatId.includes(this.u.uid)) {
            onChildAdded(query(ref(db, `direct_messages/${chatId}`), limitToLast(1)), (mSnap) => {
               if (!isInitialLoad && mSnap.val().uid !== this.u.uid && currentDmId !== chatId) this.notify(window.t('msg_notif'));
            });
          }
        });
        setTimeout(() => { isInitialLoad = false; }, 2000);
      },

      async addFriend(targetUid) {
        const myPath = `friends/${this.u.uid}/${targetUid}`, theirPath = `friends/${targetUid}/${this.u.uid}`;
        const snap = await get(ref(db, myPath)), status = snap.val();
        if (!status) { await set(ref(db, myPath), 'pending_out'); await set(ref(db, theirPath), 'pending_in'); this.notify(window.t('sent')); }
        else if (status === 'pending_in') { await set(ref(db, myPath), 'friends'); await set(ref(db, theirPath), 'friends'); this.notify(window.t('accept')); }
        document.getElementById('mini-modal').classList.add('hidden');
      },

      async removeFriend(targetUid) {
        if(await this.ask(window.t('friend_rem_q'))) {
          await remove(ref(db, `friends/${this.u.uid}/${targetUid}`));
          await remove(ref(db, `friends/${targetUid}/${this.u.uid}`));
          this.notify(window.t('link_removed'));
          document.getElementById('mini-modal').classList.add('hidden');
        }
      },

      async deleteDmMsg(msgId) {
        if(await this.ask(window.t('del_msg'))) {
          await remove(ref(db, `direct_messages/${currentDmId}/${msgId}`));
        }
      },

      downloadFile(base64, name) {
        const a = document.createElement('a');
        a.href = base64;
        a.download = name || "file";
        a.click();
      },

      async startRecording() {
        try {
          if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            this.notify("HTTPS REQUIRED FOR MIC", "err");
            return;
          }
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
          mediaRecorder.onstop = () => this.sendVoice();
          mediaRecorder.start();
          document.getElementById('voice-btn').classList.add('bg-red-600', 'animate-pulse');
        } catch (err) { 
          console.error(err);
          this.notify("MIC ERROR: " + err.name, "err"); 
        }
      },

      stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          document.getElementById('voice-btn').classList.remove('bg-red-600', 'animate-pulse');
        }
      },

      async sendVoice() {
        if (audioChunks.length === 0) return;
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.onload = async (e) => {
          await push(ref(db, `direct_messages/${currentDmId}`), { 
            uid: this.u.uid, 
            msg: e.target.result, 
            type: 'audio', 
            ts: Date.now() 
          });
        };
        reader.readAsDataURL(blob);
      },

      openDm(targetUid, targetName) {
        const ids = [this.u.uid, targetUid].sort();
        currentDmId = ids.join("_");
        document.getElementById('dm-target-name').innerText = targetName;
        document.getElementById('dm-modal').classList.remove('hidden');
        document.getElementById('mini-modal').classList.add('hidden');
        
        const dmRef = ref(db, `direct_messages/${currentDmId}`);
        off(dmRef);
        onValue(query(dmRef, limitToLast(30)), (s) => {
          const b = document.getElementById('dm-box'); b.innerHTML = '';
          s.forEach(m => {
            const v = m.val(), isMe = v.uid === this.u.uid, mid = m.key;
            let content = v.msg;
            if (v.type === 'image') content = `<img src="${v.msg}" class="max-w-[200px] rounded-2xl border border-white/10">`;
            else if (v.type === 'video') content = `<div class="bg-black/20 p-2 rounded-2xl"><video src="${v.msg}" controls class="max-w-[240px] rounded-xl outline-none shadow-lg"></video></div>`;
            else if (v.type === 'audio') content = `<audio src="${v.msg}" controls class="w-[200px] brightness-75"></audio>`;
            else if (v.type === 'file') content = `<div class="bg-black/20 p-4 rounded-xl flex items-center gap-4"><div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center text-[8px]">DOC</div><div class="flex-1"><div class="text-[7px] opacity-40 uppercase mb-2">${v.fileName || 'FILE'}</div><button onclick="core.downloadFile('${v.msg}', '${v.fileName}')" class="text-blue-500 font-black text-[9px] uppercase tracking-widest">DOWNLOAD</button></div></div>`;

            b.innerHTML += `<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-4 animate-slide"><div onclick="${isMe ? `core.deleteDmMsg('${mid}')` : ''}" class="px-4 py-3 rounded-2xl text-[10px] font-bold ${isMe ? 'bg-blue-600 text-white rounded-tr-none cursor-pointer' : 'bg-white/5 text-white/70 rounded-tl-none'}">${content}</div></div>`;
          });
          b.scrollTop = b.scrollHeight;
        });
      },

      async sendDm() {
        const i = document.getElementById('dm-in');
        if(!i.value.trim() || !currentDmId) return;
        await push(ref(db, `direct_messages/${currentDmId}`), { uid: this.u.uid, msg: i.value.trim(), type: 'text', ts: Date.now() });
        i.value = '';
      },

      async sendDmFile(e) {
        const file = e.target.files[0];
        if (!file || !currentDmId) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
          let type = 'file';
          if (file.type.startsWith('image/')) type = 'image';
          else if (file.type.startsWith('video/')) type = 'video';
          else if (file.type.startsWith('audio/')) type = 'audio';
          await push(ref(db, `direct_messages/${currentDmId}`), { 
            uid: this.u.uid, 
            msg: ev.target.result, 
            type: type, 
            fileName: file.name,
            ts: Date.now() 
          });
        };
        reader.readAsDataURL(file);
      },

      renderFriendsList(uid) {
        const listEl = document.getElementById('p-friends-list');
        const fRef = ref(db, `friends/${uid}`);
        off(fRef);
        onValue(fRef, async (snap) => {
          listEl.innerHTML = '';
          const data = snap.val();
          if (!data) { listEl.innerHTML = `<p class="text-[8px] opacity-10 font-black text-center mt-4 text-white uppercase">EMPTY</p>`; return; }
          for (const [fUid, status] of Object.entries(data)) {
            if (status === 'friends' || (status === 'pending_in' && uid === this.u.uid)) {
              const fSnap = await get(ref(db, `users/${fUid}`)), fData = fSnap.val();
              if (!fData) continue;
              const isP = status === 'pending_in';
              const isOnline = this.isUserOnline(fUid);
              listEl.innerHTML += `<div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center mb-2 animate-slide">
                <div class="flex items-center gap-3 cursor-pointer" onclick="core.showMini('${fUid}')">
                  <div class="relative">
                    <div class="w-8 h-8 rounded-lg bg-cover bg-center bg-zinc-800" style="background-image:url(${fData.avatar || ''})"></div>
                    <div class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border border-black ${isOnline ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]' : 'bg-gray-500'}"></div>
                  </div>
                  <div>
                    <div class="text-[9px] font-black uppercase text-white">${fData.name}</div>
                    <div class="text-[6px] font-black opacity-30 uppercase text-white">${isP ? 'REQUEST' : 'FRIEND'}</div>
                  </div>
                </div>
                <div class="flex gap-1">
                  ${!isP ? `<button onclick="core.openDm('${fUid}', '${fData.name}')" class="bg-blue-600/20 text-blue-500 w-8 h-8 rounded-lg flex items-center justify-center">${msgIcon}</button>` : ''}
                  ${isP ? `<button onclick="core.addFriend('${fUid}')" class="bg-green-600/20 text-green-500 w-8 h-8 rounded-lg font-black text-[10px]">✓</button>` : ''}
                  <button onclick="core.removeFriend('${fUid}')" class="bg-red-500/10 text-red-500/50 w-8 h-8 rounded-lg font-black text-[10px]">×</button>
                </div>
              </div>`;
            }
          }
        });
      },

      async toggleBan(uid, currentStatus) {
        if(uid === this.u.uid) return this.notify(window.t('cannot_ban_self'), "err");
        if(await this.ask(`${currentStatus ? window.t('unban_q') : window.t('ban_q')}`)) {
          await update(ref(db, `users/${uid}`), { isBan: !currentStatus });
          this.notify(window.t('status_updated'));
          document.getElementById('mini-modal').classList.add('hidden');
        }
      },

      async uploadMedia(e, type) {
        const f = e.target.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = async (ev) => {
          if (type === 'tempOp') { this.tempCover = ev.target.result; document.getElementById('op-preview').style.backgroundImage = `url(${ev.target.result})`; }
          else { await update(ref(db, `users/${this.u.uid}`), { [type]: ev.target.result }); this.notify(type.toUpperCase() + " UPDATED"); }
        };
        r.readAsDataURL(f);
      },

      async sendMsg() {
        const i = document.getElementById('chat-in');
        if(!i.value.trim()) return;
        await push(ref(db, `chats/${this.currentTid}`), { uid: this.u.uid, name: this.userData.name, msg: i.value.trim(), ts: Date.now() });
        i.value = '';
      },

      listenChat(tid) {
        const cRef = ref(db, `chats/${tid}`);
        off(cRef);
        onValue(query(cRef, limitToLast(30)), (s) => {
          const b = document.getElementById('chat-box'); b.innerHTML = '';
          s.forEach(m => {
            const v = m.val(), isMe = v.uid === this.u.uid;
            b.innerHTML += `<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-4"><span class="text-[7px] font-black opacity-20 uppercase mb-1 text-white">${v.name}</span><div class="px-4 py-3 rounded-2xl text-[10px] font-bold ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white/5 text-white/70 rounded-tl-none'}">${v.msg}</div></div>`;
          });
          b.scrollTop = b.scrollHeight;
        });
      },

      async showMini(uid) {
        const s = await get(ref(db, `users/${uid}`)), d = s.val(); if(!d) return;
        const style = this.getUserStyle(d);
        const exr = d.exr || 0;
        const level = this.getExrLevel(exr);
        const nextExr = this.getExrNext(exr);
        const isOnline = this.isUserOnline(uid);
        
        const fSnap = await get(ref(db, `friends/${this.u.uid}/${uid}`)), fStatus = fSnap.val();
        let friendBtn = '';
        if (uid !== this.u.uid) {
          if (!fStatus) friendBtn = `<button onclick="core.addFriend('${uid}')" class="w-full py-4 bg-blue-600/20 text-blue-500 rounded-2xl text-[8px] font-black uppercase mt-2">${window.t('add_friend')}</button>`;
          else if (fStatus === 'pending_out') friendBtn = `<button class="w-full py-4 bg-white/5 text-white/20 rounded-2xl text-[8px] font-black uppercase mt-2" disabled>${window.t('sent')}</button>`;
          else if (fStatus === 'pending_in') friendBtn = `<button onclick="core.addFriend('${uid}')" class="w-full py-4 bg-green-600/20 text-green-500 rounded-2xl text-[8px] font-black uppercase mt-2">${window.t('accept')}</button>`;
          else friendBtn = `<div class="flex gap-2"><button onclick="core.openDm('${uid}', '${d.name}')" class="flex-1 py-4 bg-blue-600/20 text-blue-500 rounded-2xl text-[8px] font-black uppercase mt-2 flex items-center justify-center gap-2">${msgIcon} ${window.t('chat')}</button><button onclick="core.removeFriend('${uid}')" class="w-14 py-4 bg-red-600/10 text-red-500/40 rounded-2xl text-[8px] font-black uppercase mt-2">×</button></div>`;
        }
        let linksH = d.socials ? `<div class="flex flex-wrap gap-2 justify-center mb-6">${Object.values(d.socials).map(sl => `<a href="${sl.url}" target="_blank" class="bg-white/5 px-3 py-2 rounded-lg text-[7px] font-black text-blue-500 border border-white/5 uppercase">${sl.label}</a>`).join('')}</div>` : '';
        const isAdmin = this.userData?.isMaker || this.userData?.isAdmin;
        const banBtn = (isAdmin && !d.isMaker && uid !== this.u.uid) ? `<button onclick="core.toggleBan('${uid}', ${d.isBan || false})" class="mt-2 w-full py-4 ${d.isBan ? 'bg-green-600/20 text-green-500' : 'bg-red-600/20 text-red-500'} rounded-2xl text-[8px] font-black uppercase tracking-[0.3em]">${d.isBan ? 'UNBAN' : 'BAN'}</button>` : '';
        
        const iconId = 'mini-exr-icon-' + Math.random().toString(36).substr(2, 9);
        
        document.getElementById('mini-content').innerHTML = `<div class="bg-[#0a0a0a] w-[340px] rounded-[3rem] overflow-hidden border ${d.isBan ? 'border-red-600' : 'border-white/10'} shadow-2xl relative">
          <div class="h-28 bg-zinc-900 bg-cover bg-center" style="background-image:url(${d.banner||''})"></div>
          <div class="px-8 pb-10 text-center">
            <div class="relative inline-block">
              <div class="w-20 h-20 mx-auto -mt-10 mb-4 bg-zinc-800 rounded-[2rem] border-[4px] border-[#0a0a0a] bg-cover bg-center" style="background-image:url(${d.avatar||''})"></div>
              <div class="absolute bottom-2 right-2 w-4 h-4 rounded-full border-2 border-[#0a0a0a] ${isOnline ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]' : 'bg-gray-500'}"></div>
            </div>
            <h3 class="text-2xl font-black italic uppercase tracking-tighter ${style.class}">${d.name}</h3>
            <p class="text-[7px] font-black opacity-40 tracking-[0.4em] mt-1 mb-4 text-white">${style.sub}</p>
            <div class="flex items-center gap-3 bg-white/5 px-4 py-2 rounded-xl border border-white/5 mb-6">
              <div class="text-[10px] font-black text-blue-500 italic truncate flex-1">${uid}</div>
              <button onclick="core.copyId('${uid}')" class="bg-white/10 px-3 py-1 rounded-lg text-[7px] font-black uppercase text-white active:scale-95">${window.t('copy')}</button>
            </div>
            ${linksH}
            
            <!-- EXR блок с молнией -->
            <div class="bg-white/5 p-6 rounded-[2rem] border border-white/5 w-full mb-4">
              <div class="flex items-center gap-3">
                <div id="${iconId}" class="flex-shrink-0 w-16 h-10 text-blue-500"></div>
                <div class="flex-grow">
                  <div class="flex items-center justify-between">
                    <div class="text-left">
                      <p class="text-2xl font-black text-blue-500">${exr}</p>
                      <p class="text-[6px] font-black text-blue-500/50 uppercase">EXR</p>
                    </div>
                    <div class="text-right">
                      <p class="text-xl font-black text-blue-500">${level.name}</p>
                      <p class="text-[6px] opacity-40 uppercase">${this.getExrLevelName(level)}</p>
                    </div>
                  </div>
                  <div class="mt-3 w-full bg-white/5 h-2 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500" style="width: ${this.getExrProgress(exr)}%"></div>
                  </div>
                  <div class="mt-1 text-right">
                    <span class="text-[6px] opacity-40">${window.t('to_next')}: ${nextExr} EXR</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Часы + победы/поражения -->
            <div class="grid grid-cols-3 gap-2 mb-4">
              <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                <p class="text-white font-black text-xl">${this.formatHours(d.hours)}</p>
                <p class="text-[6px] opacity-30 uppercase mt-1">${window.t('hours')}</p>
              </div>
              <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                <p class="text-blue-400 font-black text-xl">${d.wins || 0}</p>
                <p class="text-[6px] opacity-30 uppercase mt-1">${window.t('wins')}</p>
              </div>
              <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                <p class="text-red-400 font-black text-xl">${d.losses || 0}</p>
                <p class="text-[6px] opacity-30 uppercase mt-1">${window.t('losses')}</p>
              </div>
            </div>
            
            <div class="mt-2 flex flex-col gap-2">
              ${friendBtn}
              ${banBtn}
              <button onclick="document.getElementById('mini-modal').classList.add('hidden')" class="w-full py-4 bg-white/5 rounded-2xl text-[8px] font-black opacity-40 uppercase text-white">${window.t('close')}</button>
            </div>
          </div>
        </div>`;
        
        document.getElementById('mini-modal').classList.remove('hidden');
        
        setTimeout(() => this.renderExrIcon(level.level, iconId), 50);
      },

      async openEditTourney() {
        const s = await get(ref(db, `tourneys/${this.currentTid}`));
        const t = s.val();
        editingTourneyId = this.currentTid;
        document.getElementById('dn').value = t.name;
        document.getElementById('df').value = t.format;
        document.getElementById('dp').value = t.prize;
        document.getElementById('dd').value = t.date;
        document.getElementById('dlink').value = t.link;
        document.getElementById('ddesc').value = t.desc;
        this.tempCover = t.cover || "";
        document.getElementById('op-preview').style.backgroundImage = t.cover ? `url(${t.cover})` : 'none';
        document.getElementById('create-modal').classList.remove('hidden');
      },

      async openSecurityLink(url) {
        document.getElementById('sec-url-display').innerText = url;
        const modal = document.getElementById('security-modal');
        modal.classList.remove('hidden');
        document.getElementById('sec-connect').onclick = () => {
          window.open(url, '_blank');
          modal.classList.add('hidden');
        };
      },

      async createTourney() {
        const n = document.getElementById('dn').value.trim(), link = document.getElementById('dlink').value.trim(), fmt = document.getElementById('df').value.trim();
        if(!n || !link || !fmt) return this.notify(window.t('fill_fields'), "err");
        
        const data = { 
          name: n.toUpperCase(), 
          prize: document.getElementById('dp').value || "NO PRIZE", 
          format: fmt.toUpperCase(), 
          desc: document.getElementById('ddesc').value || "NO DESCRIPTION", 
          link: link, 
          cover: this.tempCover || "", 
          date: document.getElementById('dd').value || "TBA"
        };

        if(editingTourneyId) {
          await update(ref(db, `tourneys/${editingTourneyId}`), data);
          this.notify("EVENT UPDATED");
          editingTourneyId = null;
        } else {
          const tid = push(ref(db, 'tourneys')).key, sc = "AX-" + Math.floor(100 + Math.random() * 899);
          await set(ref(db, `tourneys/${tid}`), { ...data, id: tid, code: sc, owner: this.u.uid, status: 'open' });
          this.notify(`${window.t('event_created')} ${sc}`);
        }
        
        document.getElementById('create-modal').classList.add('hidden');
        this.tempCover = "";
      },

      async renderTeam(side, p, format, status) {
        const box = document.getElementById('t-' + side), parts = format.split(/v|vs/i).map(s => parseInt(s.trim()));
        const limit = side === 'alpha' ? (parts[0] || 1) : (parts[1] || 1), count = p ? Object.keys(p).length : 0;
        let h = `<div class="text-[10px] font-black uppercase mb-6 text-center tracking-[0.4em] ${side==='alpha'?'text-blue-500':'text-red-500'}">${side} [${count}/${limit}]</div>`;
        if(p) {
          for (const [uid, name] of Object.entries(p)) {
            const s = await get(ref(db, `users/${uid}`)), st = this.getUserStyle(s.val());
            const isOnline = this.isUserOnline(uid);
            h += `<div onclick="core.showMini('${uid}')" class="relative bg-white/5 p-5 border-l-4 ${side==='alpha'?'border-blue-600':'border-red-600'} mb-3 text-xs font-black uppercase italic rounded-[1.2rem] flex justify-between items-center">
              <div class="flex items-center gap-2">
                <div class="relative">
                  <div class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]' : 'bg-gray-500'}"></div>
                </div>
                <span class="${st.class}">${name}</span>
              </div>
              ${uid === this.u.uid && status === 'open' ? `<div onclick="event.stopPropagation(); core.leaveTeam('${side}')" class="bg-red-500/10 text-red-500 px-3 py-1 rounded-lg text-[7px] border border-red-500/20 font-black">LEAVE</div>` : ''}
            </div>`;
          }
        }
        for(let i=count; i<limit; i++) h += `<div onclick="core.join('${side}')" class="border border-dashed border-white/5 p-5 mb-3 text-center opacity-20 text-[8px] font-black uppercase cursor-pointer rounded-[1.2rem] hover:opacity-100 text-white">${window.t('vacant')}</div>`;
        box.innerHTML = h;
      },

      async finishMatch(winner) {
        if (!winner) return;
        
        if (!this.currentTid) return;
        
        const tSnap = await get(ref(db, `tourneys/${this.currentTid}`));
        const t = tSnap.val();
        
        if (!t || t.status === 'finished') {
          return this.notify("MATCH ALREADY FINISHED", "err");
        }

        const winnerTeam = winner === 'alpha' ? t.alpha : t.omega;
        const loserTeam = winner === 'alpha' ? t.omega : t.alpha;

        if (!winnerTeam || !loserTeam || Object.keys(winnerTeam).length === 0 || Object.keys(loserTeam).length === 0) {
          return this.notify("TEAMS NOT FULL", "err");
        }

        this.notify(`CALCULATION EXR...`);

        for (const uid of Object.keys(winnerTeam)) {
          const userSnap = await get(ref(db, `users/${uid}`));
          const userData = userSnap.val();
          const currentExr = userData.exr || 0;
          const newExr = currentExr + 25;
          
          await update(ref(db, `users/${uid}`), {
            exr: newExr,
            wins: increment(1)
          });
        }

        for (const uid of Object.keys(loserTeam)) {
          const userSnap = await get(ref(db, `users/${uid}`));
          const userData = userSnap.val();
          const currentExr = userData.exr || 0;
          const newExr = Math.max(0, currentExr - 15);
          
          await update(ref(db, `users/${uid}`), {
            exr: newExr,
            losses: increment(1)
          });
        }

        await remove(ref(db, `tourneys/${this.currentTid}`));
        await remove(ref(db, `chats/${this.currentTid}`));

        this.notify(`THE MATCH IS OVER! EXR UPDATE`, 'success');
        this.show('home');
      },

      async askFinish() {
        const tSnap = await get(ref(db, `tourneys/${this.currentTid}`));
        const t = tSnap.val();
        
        if (t.status === 'finished') {
          return this.notify("MATCH ALREADY FINISHED", "err");
        }

        if (!t.alpha || !t.omega || Object.keys(t.alpha).length === 0 || Object.keys(t.omega).length === 0) {
          return this.notify("BOTH TEAMS MUST HAVE PLAYERS", "err");
        }

        const winner = await this.askWinner();
        if (winner) {
          await this.finishMatch(winner);
        }
      },

      async login() {
        const n = document.getElementById('an').value.toLowerCase().trim(), p = document.getElementById('ap').value;
        signInWithEmailAndPassword(auth, n + "@arena.exe", p).catch(() => this.notify(window.t('access_denied'), "err"));
      },

      async register() {
        const n = document.getElementById('an').value.trim(), p = document.getElementById('ap').value;
        createUserWithEmailAndPassword(auth, n.toLowerCase() + "@arena.exe", p).then(async (c) => {
            await set(ref(db, 'users/' + c.user.uid), { 
              uid: c.user.uid, 
              name: n.toUpperCase(), 
              exr: 0,
              wins: 0, 
              losses: 0, 
              hours: 0, 
              isMaker: false, 
              isBan: false,
              lastSeen: Date.now()
            });
        }).catch(() => this.notify(window.t('reg_err'), "err"));
      },

      async renderProfile(uid) {
        this.renderFriendsList(uid);
        const uRef = ref(db, `users/${uid}`);
        off(uRef);
        onValue(uRef, (s) => {
          const d = s.val(); if(!d) return;
          const isMy = uid === this.u.uid, style = this.getUserStyle(d), banner = document.getElementById('p-banner');
          const exr = d.exr || 0;
          const level = this.getExrLevel(exr);
          const nextExr = this.getExrNext(exr);
          const isOnline = this.isUserOnline(uid);
          
          banner.style.backgroundImage = d.banner ? `url(${d.banner})` : 'none';
          if(isMy) { banner.onclick = () => document.getElementById('bi-set').click(); banner.classList.add('cursor-pointer'); }
          
          document.getElementById('p-avatar-wrap').innerHTML = `
            <div class="relative inline-block">
              <div id="p-avatar" class="w-32 h-32 md:w-48 md:h-48 bg-zinc-800 border-[8px] border-[#060606] bg-cover bg-center rounded-[2.5rem] relative z-10" style="background-image:url(${d.avatar||''})" onclick="if(${isMy}) document.getElementById('ai-set').click()"></div>
              <div class="absolute bottom-2 right-2 w-5 h-5 md:w-6 md:h-6 rounded-full border-2 border-[#060606] ${isOnline ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]' : 'bg-gray-500'}"></div>
            </div>
          `;
          
          document.getElementById('p-name-container').innerHTML = `<div class="flex items-center gap-4 flex-wrap"><h2 class="text-4xl md:text-8xl font-black italic uppercase tracking-tighter ${style.class} leading-none">${d.name}</h2>${isMy ? `<button onclick="core.openEditName()" class="w-10 h-10 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center opacity-30 text-white">✎</button>` : ''}</div>`;
          document.getElementById('p-sub-container').innerHTML = `<div class="flex flex-col md:flex-row md:items-center gap-4 mt-4"><p class="text-[10px] font-black opacity-20 tracking-[0.5em] uppercase text-white">${style.sub}</p><div class="flex items-center gap-3 bg-white/5 px-4 py-2 rounded-xl border border-white/5 max-w-fit"><div class="text-[10px] font-black text-blue-500 italic truncate">${uid}</div><button onclick="core.copyId('${uid}')" class="bg-white/10 px-3 py-1 rounded-lg text-[7px] font-black uppercase text-white active:scale-95">${window.t('copy')}</button></div></div>`;
          
          document.getElementById('p-exr-container').innerHTML = `
            <div class="bg-white/5 p-8 rounded-[2rem] border border-white/5 w-full relative overflow-visible">
              <div class="flex items-center gap-4">
                <div id="exr-mini-icon" class="flex-shrink-0"></div>
                <div class="flex-grow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-5xl font-black text-blue-500">${exr}</p>
                      <p class="text-[8px] font-black text-blue-500/50 uppercase">EXR</p>
                    </div>
                    <div class="text-right">
                      <p class="text-3xl font-black text-blue-500">${level.name}</p>
                      <p class="text-[8px] opacity-40 uppercase">${this.getExrLevelName(level)}</p>
                    </div>
                  </div>
                  <div class="mt-6 w-full bg-white/5 h-3 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500" style="width: ${this.getExrProgress(exr)}%"></div>
                  </div>
                  <div class="mt-2 text-right">
                    <span class="text-[8px] opacity-40">${window.t('to_next')}: ${nextExr} EXR</span>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          document.getElementById('p-wins').innerText = d.wins || 0;
          document.getElementById('p-losses').innerText = d.losses || 0;
          
          setTimeout(() => this.renderExrIcon(level.level, 'exr-mini-icon'), 100);
          
          document.getElementById('p-hours').innerText = this.formatHours(d.hours);
          const lb = document.getElementById('p-links'); lb.innerHTML = '';
          if(d.socials) Object.entries(d.socials).forEach(([id, sl]) => {
              lb.innerHTML += `<div class="bg-white/5 p-5 border border-white/5 mb-3 flex justify-between items-center rounded-[1.5rem]"><div class="overflow-hidden"><div class="text-[8px] opacity-30 font-black uppercase text-white">${sl.label}</div><a href="${sl.url}" target="_blank" class="text-blue-500 font-bold text-xs uppercase truncate block">URL</a></div>${isMy ? `<div class="flex gap-2"><button onclick="core.openLinkEdit('${id}', '${sl.label}', '${sl.url}')" class="w-10 h-10 bg-white/5 rounded-xl text-[10px] opacity-20 hover:opacity-100">✎</button><button onclick="core.deleteLink('${id}')" class="w-10 h-10 bg-white/5 rounded-xl text-[14px] opacity-20 hover:opacity-100 hover:text-red-500">×</button></div>` : ''}</div>`;
          });
          if(isMy) {
            let shopH = `<div class="mt-8 pt-8 border-t border-white/5"><button onclick="core.openLinkEdit()" class="w-full bg-white/5 py-4 font-black uppercase text-[8px] rounded-2xl border border-white/5 text-white/40 mb-10">${window.t('add_link')}</button>`;
            shopH += `
            <div class="mb-10 space-y-6">
              <div class="p-8 bg-yellow-500/5 border border-yellow-500/10 rounded-[2.5rem] relative overflow-hidden group">
                <div class="text-[8px] font-black text-yellow-500 tracking-[0.4em] mb-6 uppercase italic">${window.t('pro_service')}</div>
                <ul class="text-[10px] font-black text-white/70 space-y-4 uppercase mb-8 leading-relaxed">
                  <li>• UNIQUE NICKNAME EFFECT</li>
                  <li>• GIF SUPPORT</li>
                  <li>• UNIQUE STATUS</li>
                </ul>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <a href="https://www.sberbank.ru/ru/choise_bank?requisiteNumber=79192892667&bankCode=100000000111" target="_blank" class="bg-yellow-500 py-4 rounded-2xl text-black font-black text-[10px] text-center uppercase tracking-widest active:scale-95 transition-all">${window.t('sber')}</a>
                  <a href="http://t.me/ARENAexeSUPPORT?direct" target="_blank" class="bg-white/10 py-4 rounded-2xl text-white font-black text-[10px] text-center uppercase tracking-widest border border-white/5 active:scale-95 transition-all">${window.t('support')}</a>
                </div>
              </div>

              <div class="p-8 bg-red-600/5 border border-red-600/10 rounded-[2.5rem] relative overflow-hidden group">
                <div class="text-[8px] font-black text-red-600 tracking-[0.4em] mb-6 uppercase italic">${window.t('become_admin')}</div>
                <ul class="text-[10px] font-black text-white/70 space-y-4 uppercase mb-8 leading-relaxed">
                  <li>• UNIQUE NICKNAME EFFECT</li>
                  <li>• PROJECT MODERATION</li>
                  <li>• UNIQUE STATUS</li>
                </ul>
                <a href="http://t.me/ARENAexeSUPPORT?direct" target="_blank" class="w-full block bg-red-600 py-4 rounded-2xl text-white font-black text-[10px] text-center uppercase tracking-widest active:scale-95 transition-all">${window.t('contact_owner')}</a>
              </div>
            </div>`;

            document.getElementById('p-edit-controls').innerHTML = shopH + `</div>`;
            document.getElementById('p-edit-controls').classList.remove('hidden');
          }
          document.getElementById('p-logout-btn').classList.toggle('hidden', !isMy);
        });
      },

      loadList() {
        const tRef = ref(db, 'tourneys');
        off(tRef);
        onValue(tRef, (snap) => {
          const g = document.getElementById('tourney-grid'); g.innerHTML = '';
          const data = snap.val(); if(!data) return;
          Object.entries(data).reverse().forEach(([id, t]) => {
            g.innerHTML += `<div onclick="core.openLobby('${id}')" class="bg-[#0d0d0d] border border-white/5 hover:border-blue-600 rounded-[2.5rem] overflow-hidden group cursor-pointer transition-all"><div class="h-56 bg-zinc-900 bg-cover bg-center group-hover:scale-105 transition duration-700" style="background-image:url(${t.cover || ''})"></div><div class="p-8 flex justify-between items-start"><div><h3 class="text-2xl font-black italic uppercase tracking-tighter leading-none text-white">${t.name}</h3><div class="mt-4"><p class="text-[9px] text-blue-500 font-black uppercase tracking-widest">${window.t('format')}: ${t.format} • ${window.t('prize')}: ${t.prize}</p></div></div><div class="text-right"><div class="text-[9px] font-black text-white/20 mb-1">${t.code}</div><div class="text-[8px] opacity-10 font-black uppercase text-white">${t.date}</div></div></div></div>`;
          });
        });
      },

      async openLobby(tid) {
        this.currentTid = tid; this.show('lobby'); this.listenChat(tid);
        const lRef = ref(db, `tourneys/${tid}`);
        off(lRef);
        onValue(lRef, async (snap) => {
          const t = snap.val(); if(!t || this.currentTid !== tid) return;
          const ownerSnap = await get(ref(db, `users/${t.owner}`)), ownerData = ownerSnap.val(), ownerStyle = this.getUserStyle(ownerData);
          document.getElementById('l-cover').style.backgroundImage = `url(${t.cover || ''})`;
          
          const isAdmin = this.userData?.isMaker || this.userData?.isAdmin || t.owner === this.u.uid;
          
          document.getElementById('ln-container').innerHTML = `<h1 id="ln" class="text-5xl font-black uppercase italic tracking-tighter text-white">${t.name}</h1>${isAdmin ? `<button onclick="core.openEditTourney()" class="w-10 h-10 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center opacity-30 text-white">✎</button>` : ''}`;
          
          document.getElementById('l-code-text').innerText = t.code;
          document.getElementById('lp').innerText = `${window.t('prize')}: ${t.prize} | ${window.t('format')}: ${t.format}`;
          document.getElementById('l-owner').innerHTML = `<span class="opacity-20 mr-2">${window.t('by')}</span><span onclick="core.showMini('${t.owner}')" class="cursor-pointer hover:opacity-100 ${ownerStyle.class}">${ownerData?.name || '...'}</span>`;
          
          const isMember = (t.alpha && t.alpha[this.u.uid]) || (t.omega && t.omega[this.u.uid]);
          document.getElementById('l-link-box').innerHTML = (t.link && (isMember || isAdmin)) ? `
            <div class="flex gap-2">
              <button onclick="core.openSecurityLink('${t.link}')" class="bg-white/5 border border-white/10 w-12 h-12 flex items-center justify-center rounded-xl text-white/40 hover:text-blue-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
              <a href="${t.link}" target="_blank" class="bg-blue-600 px-6 py-3 rounded-xl text-[9px] font-black tracking-widest text-white flex items-center">${window.t('connect')}</a>
            </div>
          ` : '';
          document.getElementById('ldesc').innerText = t.desc;
          document.getElementById('lobby-controls').innerHTML = isAdmin ? `<button onclick="core.deleteTourney('${tid}')" class="text-[9px] text-red-500 font-black uppercase opacity-30">${window.t('delete_event')}</button>` : '';
          
          const finishBtnContainer = document.getElementById('finish-btn-container');
          if (isAdmin && t.alpha && t.omega && Object.keys(t.alpha).length > 0 && Object.keys(t.omega).length > 0) {
            finishBtnContainer.innerHTML = `
              <div class="w-full mt-6 mb-8">
                <button onclick="core.askFinish()" class="w-full bg-red-600 py-8 rounded-2xl font-black text-[14px] uppercase tracking-widest text-white border-2 border-red-500 shadow-[0_0_30px_rgba(220,38,38,0.5)] hover:scale-[1.02] transition-all duration-300">
                  ${window.t('finish_match')}
                </button>
              </div>
            `;
          } else {
            finishBtnContainer.innerHTML = '';
          }
          
          this.renderTeam('alpha', t.alpha, t.format, t.status || 'open'); 
          this.renderTeam('omega', t.omega, t.format, t.status || 'open');
        });
      }
    };

    // ========== ПРОСТАЯ РАБОЧАЯ СИСТЕМА ОНЛАЙНА ==========
    function initOnlineTracking() {
      const user = auth.currentUser;
      if (!user) return;

      const userStatusRef = ref(db, `status/${user.uid}`);
      
      // При подключении к Firebase
      const connectedRef = ref(db, '.info/connected');
      onValue(connectedRef, (snap) => {
        if (snap.val() === true) {
          // Устанавливаем онлайн статус
          set(userStatusRef, {
            online: true,
            lastSeen: Date.now()
          }).catch(() => {});
          
          // При отключении
          onDisconnect(userStatusRef).set({
            online: false,
            lastSeen: Date.now()
          });
        }
      });

      // При выходе со страницы
      window.addEventListener('beforeunload', () => {
        set(userStatusRef, {
          online: false,
          lastSeen: Date.now()
        }).catch(() => {});
      });
    }

    // Следим за статусами всех пользователей
    function trackOnlineStatus() {
      const statusRef = ref(db, 'status');
      onValue(statusRef, (snap) => {
        const statuses = snap.val() || {};
        onlineUsers = {};
        
        Object.keys(statuses).forEach(uid => {
          if (statuses[uid]?.online === true) {
            onlineUsers[uid] = true;
          }
        });
        
        // Обновляем UI если нужно
        if (window.core?.currentTid) {
          window.core.openLobby(window.core.currentTid);
        }
        if (window.core?.u?.uid) {
          window.core.renderProfile(window.core.u.uid);
        }
      });
    }

    onAuthStateChanged(auth, (user) => {
      if(user) {
        onValue(ref(db, `users/${user.uid}`), (s) => {
          const d = s.val(); if (d && d.isBan) { 
            signOut(auth).then(() => { 
              localStorage.clear(); 
              location.reload(); 
            }); 
            return; 
          }
          window.core.u = user; 
          window.core.userData = d;
          document.getElementById('auth-screen').classList.add('hidden');
          document.getElementById('nav-avatar').style.backgroundImage = d?.avatar ? `url(${d.avatar})` : 'none';
          if(!siteInterval) siteInterval = setInterval(() => { 
            update(ref(db, `users/${user.uid}`), { hours: increment(1) }); 
          }, 60000);
          window.core.initGlobalListeners(); 
          window.core.loadList();
          
          // Запускаем отслеживание онлайна
          initOnlineTracking();
          trackOnlineStatus();
        });
      } else { 
        document.getElementById('auth-screen').classList.remove('hidden'); 
        if(siteInterval) { 
          clearInterval(siteInterval); 
          siteInterval = null; 
        }
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-i18n]').forEach(el => { el.innerText = window.t(el.getAttribute('data-i18n')); });
      document.querySelectorAll('[data-i18n-ph]').forEach(el => { el.placeholder = window.t(el.getAttribute('data-i18n-ph')); });
      
      const voiceBtn = document.getElementById('voice-btn');
      if (voiceBtn) {
        ['mousedown', 'touchstart'].forEach(evt => voiceBtn.addEventListener(evt, (e) => {
          e.preventDefault(); core.startRecording();
        }));
        ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => voiceBtn.addEventListener(evt, (e) => {
          e.preventDefault(); core.stopRecording();
        }));
      }
    });
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,900;1,900&display=swap');
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Montserrat', sans-serif; background: #060606; color: #fff; overflow-x: hidden; }
    .hidden { display: none !important; }
    input, select, textarea { background: #111 !important; border: 1px solid #222 !important; color: #fff !important; border-radius: 1.2rem; padding: 1.2rem; outline: none; width: 100%; font-weight: 900; text-transform: uppercase; font-size: 10px; }
    .txt-maker { background: linear-gradient(90deg, #a855f7, #ec4899, #a855f7); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: flow 4s ease infinite; text-shadow: 0 0 15px rgba(168, 85, 247, 0.8); }
    .txt-elite { background: linear-gradient(90deg, #ff0000, #ff8a00, #ff0000); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: flow 2s linear infinite; text-shadow: 0 0 15px rgba(255, 0, 0, 0.9); }
    .txt-admin { color: #ef4444; text-shadow: 0 0 15px rgba(239, 68, 68, 0.8); }
    .txt-pro { background: linear-gradient(90deg, #ca8a04, #fde047, #ca8a04); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: flow 3s linear infinite; text-shadow: 0 0 15px rgba(234, 179, 8, 0.8); }
    @keyframes flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .section { min-height: 100vh; display: flex; flex-direction: column; }
    .stats-fit { font-size: clamp(1rem, 15cqw, 4.5rem); line-height: 1; white-space: nowrap; }
    .custom-scroll::-webkit-scrollbar { display: none; }
    @keyframes slide { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .animate-slide { animation: slide 0.4s ease forwards; }
    
    .promo-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 2.5rem; padding: 24px; margin-top: 15px; width: 100%; max-width: 360px; }
    .eda-btn { background: #ffc000; color: #000; border-radius: 1.2rem; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s; }
    .apk-btn { background: #3ddc84; color: #000; border-radius: 1.2rem; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s; }
    .lang-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 8px 16px; border-radius: 1rem; font-size: 10px; font-weight: 900; color: #3b82f6; cursor: pointer; }

    .yandex-border {
      border: 4px solid #ffc000;
      border-radius: 1.25rem;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(255, 192, 0, 0.3);
    }

    #p-logout-btn {
      background: #dc2626 !important;
      border: 1px solid #991b1b !important;
      color: white !important;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      transition: all 0.2s;
    }
    #p-logout-btn:hover {
      background: #b91c1c !important;
      transform: scale(1.02);
    }
    #p-logout-btn:active {
      transform: scale(0.98);
    }

    .exe-blue {
      color: #3b82f6 !important;
      font-weight: 900;
    }
  </style>
</head>
<body class="p-4 md:p-10">
  <div id="notif-container" class="fixed top-8 right-8 z-[1000000] w-full max-w-xs pointer-events-none"></div>
  
  <header class="flex justify-between items-center mb-12 pb-8 border-b border-white/5 max-w-[1200px] mx-auto">
    <div onclick="core.show('home')" class="text-3xl font-black italic cursor-pointer tracking-tighter uppercase text-white">
      ARENA<span class="exe-blue">.EXE</span>
    </div>
    <div class="flex items-center gap-4">
      <button onclick="window.toggleLang()" class="lang-btn">RU | EN</button>
      <div id="nav-avatar" onclick="core.show('profile')" class="w-16 h-16 bg-zinc-900 bg-cover bg-center border-2 border-white/10 rounded-[1.5rem] cursor-pointer shadow-lg shadow-blue-600/10"></div>
    </div>
  </header>

  <main class="max-w-[1200px] mx-auto">
    <section id="section-home" class="section">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
        <div><h1 class="text-[9px] font-black opacity-30 tracking-[0.6em] uppercase text-white" data-i18n="discover">DISCOVER</h1></div>
        <div class="flex gap-4 w-full md:w-auto items-start overflow-x-auto pb-2 custom-scroll">
          <div class="flex flex-col gap-2 w-20 shrink-0">
            <input id="search-in" placeholder="AX" maxlength="6" class="!p-2 text-center h-12 !text-[9px]">
            <div onclick="core.findByCode()" class="bg-white/5 h-12 rounded-xl border border-white/10 flex items-center justify-center cursor-pointer hover:bg-blue-600/20 active:scale-95">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
            </div>
          </div>
          <div class="flex flex-col gap-2 w-20 shrink-0">
            <input id="user-search-in" placeholder="ID" class="!p-2 text-center h-12 !text-[9px]">
            <div onclick="core.findUser()" class="bg-white/5 h-12 rounded-xl border border-white/10 flex items-center justify-center cursor-pointer hover:bg-blue-600/20 active:scale-95">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
          </div>
          <button onclick="document.getElementById('create-modal').classList.remove('hidden')" class="bg-blue-600 px-8 h-[104px] font-black uppercase text-[10px] rounded-[1.2rem] text-white active:scale-95" data-i18n="create">CREATE</button>
        </div>
      </div>
      <div id="tourney-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>
    </section>

    <section id="section-profile" class="section hidden">
      <div class="bg-[#080808] rounded-[3.5rem] overflow-hidden">
        <div id="p-banner" class="h-64 md:h-80 bg-zinc-900 bg-cover bg-center relative"><div id="p-avatar-wrap" class="absolute -bottom-12 md:-bottom-16 left-8 md:left-12"></div></div>
        <input type="file" id="ai-set" class="hidden" accept="image/*" onchange="core.uploadMedia(event, 'avatar')">
        <input type="file" id="bi-set" class="hidden" accept="image/*" onchange="core.uploadMedia(event, 'banner')">
        <div class="p-8 md:p-16 pt-20 md:pt-24">
          <div id="p-name-container"></div><div id="p-sub-container"></div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-10 mt-16">
            <div class="md:col-span-2">
              <div class="grid grid-cols-2 gap-4">
                <div id="p-exr-container" class="col-span-2"></div>
                <div class="bg-white/5 p-8 text-center rounded-[2rem] border border-white/5 col-span-2">
                  <p id="p-hours" class="text-white font-black italic stats-fit">0H</p>
                  <p class="text-[8px] opacity-30 uppercase mt-4 text-white" data-i18n="hours">ONLINE</p>
                </div>
                <div class="col-span-2">
                  <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/5 p-8 rounded-[2rem] border border-white/5">
                      <p class="text-blue-400 font-black text-3xl" id="p-wins">0</p>
                      <p class="text-[8px] opacity-30 uppercase mt-2" data-i18n="wins">WINS</p>
                    </div>
                    <div class="bg-white/5 p-8 rounded-[2rem] border border-white/5">
                      <p class="text-red-400 font-black text-3xl" id="p-losses">0</p>
                      <p class="text-[8px] opacity-30 uppercase mt-2" data-i18n="losses">LOSSES</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-8"><div id="p-links"></div><div id="p-edit-controls" class="hidden"></div></div>
            </div>
            <div>
              <div class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5">
                <h3 class="text-[8px] font-black opacity-30 tracking-[0.4em] uppercase mb-6 text-white" data-i18n="friends">FRIENDS</h3>
                <div id="p-friends-list" class="max-h-[400px] overflow-y-auto custom-scroll"></div>
              </div>
              <div class="promo-card mx-auto">
                <div class="flex items-center gap-5 mb-4">
                  <div class="w-16 h-16 shrink-0 bg-cover bg-center rounded-2xl yandex-border" style="background-image: url('EDApic.png');"></div>
                  <div class="flex flex-col"><span class="text-[9px] font-black uppercase text-white tracking-widest mb-1" data-i18n="yandex_title">Yandex Food</span><h4 class="text-[11px] font-black uppercase italic text-white leading-none" data-i18n="yandex_sub">Become a courier</h4></div>
                </div>
                <p class="text-[7px] font-bold opacity-30 uppercase text-white" data-i18n="yandex_desc">Flexible schedule, daily payments and free uniform.</p>
                <a href="https://reg.eda.yandex.ru/?advertisement_campaign=forms_for_agents&user_invite_code=208d82dc0c13481c9922ff27bd1773a2&utm_content=blank" target="_blank" class="eda-btn font-black block text-center mt-4 !py-3" data-i18n="yandex_apply">Apply now</a>
              </div>
              <<div class="promo-card mx-auto mt-4">
                <div class="flex items-center gap-5 mb-4">
                  <div class="w-16 h-16 shrink-0 bg-cover bg-center rounded-2xl border-4 border-blue-600 shadow-lg shadow-blue-600/30" style="background-image: url('ICO_ARENA.PNG');"></div>
                  <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase text-white tracking-widest mb-1" data-i18n="android_title">ARENA.EXE mobile</span>
                    <h4 class="text-[11px] font-black uppercase italic text-blue-500 leading-none">ARENA.EXE</h4>
                  </div>
                </div>
                <p class="text-[7px] font-bold opacity-30 uppercase leading-relaxed text-white" data-i18n="android_desc">Tournaments always at hand. Only for Android devices.</p>
                <a href="ARENA.EXE mobile.apk" download class="apk-btn font-black block text-center mt-4 !py-3" data-i18n="download_apk">DOWNLOAD EXE</a>
              </div>
            </div>
          </div>
          <button id="p-logout-btn" 
                  onclick="signOut(auth).then(() => { localStorage.clear(); location.reload(); })" 
                  class="mt-16 w-full py-6 rounded-[2rem] font-black text-[10px] uppercase tracking-[0.15em]">
            DISCONNECT
          </button>
        </div>
      </div>
    </section>

    <section id="section-lobby" class="section hidden">
      <div class="bg-[#080808] p-10 rounded-[3.5rem] grid grid-cols-1 lg:grid-cols-3 gap-12">
        <div class="lg:col-span-2">
          <div class="flex justify-between items-center mb-8"><button onclick="core.show('home')" class="text-[10px] font-black opacity-30 uppercase italic text-white" data-i18n="back">< BACK</button><div class="flex items-center gap-4 bg-white/5 px-6 py-3 rounded-2xl border border-white/10 shadow-xl"><div id="l-code-text" class="text-2xl font-black text-blue-500 italic tracking-tighter">CODE</div><button onclick="core.copyId(document.getElementById('l-code-text').innerText)" class="bg-white/10 px-3 py-1 rounded-lg text-[8px] font-black uppercase text-white" data-i18n="copy">COPY</button></div></div>
          <div id="l-cover" class="h-64 bg-zinc-900 bg-cover bg-center mb-10 rounded-[2.5rem] shadow-2xl"></div>
          <div id="ln-container" class="flex items-center gap-4 flex-wrap mb-2"></div>
          <div id="l-owner" class="text-[9px] font-black uppercase tracking-[0.3em] mb-8 text-white"></div>
          <div class="flex items-center gap-6 mb-12"><p id="lp" class="text-blue-500 font-black text-[10px] uppercase tracking-widest"></p><div id="l-link-box"></div></div>
          
          <!-- Кнопка завершения матча -->
          <div id="finish-btn-container" class="w-full"></div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10"><div id="t-alpha"></div><div id="t-omega"></div></div>
          <div id="ldesc" class="bg-white/5 p-8 rounded-[1.5rem] text-[10px] opacity-40 uppercase text-white leading-relaxed"></div>
        </div>
        <div class="flex flex-col bg-black/40 rounded-[2.5rem] p-8 border border-white/5 h-[700px]">
          <div id="lobby-controls" class="mb-8"></div>
          <div id="chat-box" class="flex-1 overflow-y-auto mb-6 custom-scroll"></div>
          <div class="flex gap-3"><input id="chat-in" data-i18n-ph="message" onkeydown="if(event.key==='Enter')core.sendMsg()"><button onclick="core.sendMsg()" class="bg-blue-600 px-6 rounded-2xl font-black text-white flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          </button></div>
        </div>
      </div>
    </section>
  </main>

  <div id="confirm-modal" class="fixed inset-0 z-[1000000] bg-black/95 flex items-center justify-center p-6 hidden">
    <div class="bg-zinc-900 p-10 rounded-[3rem] border border-white/10 max-w-xs w-full text-center">
      <p id="confirm-text" class="text-[10px] font-black uppercase mb-8 text-white"></p>
      <div class="grid grid-cols-3 gap-4">
        <button id="confirm-yes" class="bg-blue-600 text-white py-4 rounded-2xl font-black text-[10px] uppercase col-span-1"></button>
        <button id="confirm-no" class="bg-red-600 py-4 rounded-2xl font-black text-[10px] uppercase text-white col-span-1"></button>
        <button id="confirm-cancel" class="bg-white/5 py-4 rounded-2xl font-black text-[10px] uppercase text-white col-span-1 hidden"></button>
      </div>
    </div>
  </div>

  <div id="security-modal" class="fixed inset-0 z-[1000000] bg-black/95 flex items-center justify-center p-6 hidden">
    <div class="bg-zinc-900 p-10 rounded-[3rem] border border-white/10 max-w-md w-full text-center">
      <h3 class="text-blue-500 font-black uppercase text-[10px] tracking-widest mb-4" data-i18n="security_check">SECURITY CHECK</h3>
      <p class="text-[8px] font-black opacity-30 uppercase mb-8 text-white" data-i18n="link_preview">VERIFY THE DESTINATION LINK</p>
      <div class="bg-black/40 p-6 rounded-2xl border border-white/5 mb-10 overflow-hidden">
        <p id="sec-url-display" class="text-xs font-bold text-white/70 break-all"></p>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <button id="sec-connect" class="bg-blue-600 text-white py-4 rounded-2xl font-black text-[10px] uppercase" data-i18n="connect">CONNECT</button>
        <button onclick="document.getElementById('security-modal').classList.add('hidden')" class="bg-white/5 py-4 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="close">CLOSE</button>
      </div>
    </div>
  </div>

  <div id="auth-screen" class="fixed inset-0 z-[200000] bg-black flex items-center justify-center p-6 hidden">
    <div class="w-full max-w-xs text-center">
      <h1 class="text-4xl font-black italic mb-12 tracking-tighter uppercase text-white">
        ARENA.<span class="exe-blue">EXE</span>
      </h1>
      <input id="an" placeholder="NICKNAME" class="mb-4">
      <input id="ap" type="password" placeholder="PASSWORD" class="mb-8">
      <div class="grid grid-cols-2 gap-4">
        <button onclick="core.login()" class="bg-blue-600 py-5 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="login">LOG IN</button>
        <button onclick="core.register()" class="bg-white/5 py-5 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="join">JOIN</button>
      </div>
    </div>
  </div>

  <div id="create-modal" class="fixed inset-0 z-[150000] bg-black/90 backdrop-blur-xl flex items-center justify-center p-6 hidden">
    <div class="w-full max-xl bg-zinc-900 p-10 rounded-[3rem] border border-white/10">
      <h2 class="text-2xl font-black italic uppercase mb-8 text-white text-center" data-i18n="create_event">CREATE EVENT</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="dn" data-i18n-ph="name">
        <input id="df" data-i18n-ph="format">
        <input id="dp" data-i18n-ph="prize">
        <input id="dd" data-i18n-ph="date">
        <div class="md:col-span-2">
          <input id="dlink" data-i18n-ph="match_link">
          <textarea id="ddesc" data-i18n-ph="desc" class="mt-4 h-32"></textarea>
          <div class="mt-4 flex gap-4 items-center">
            <div id="op-preview" class="w-16 h-16 bg-white/5 rounded-2xl bg-cover bg-center"></div>
            <button onclick="document.getElementById('op-set').click()" class="bg-white/5 px-6 py-4 rounded-2xl text-[8px] font-black text-white" data-i18n="upload">UPLOAD</button>
            <input type="file" id="op-set" class="hidden" accept="image/*" onchange="core.uploadMedia(event, 'tempOp')">
          </div>
        </div>
      </div>
      <div class="mt-10 flex gap-4">
        <button onclick="core.createTourney()" class="flex-1 bg-blue-600 py-5 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="publish">PUBLISH</button>
        <button onclick="document.getElementById('create-modal').classList.add('hidden'); editingTourneyId = null;" class="px-8 bg-white/5 rounded-2xl font-black text-[10px] text-white uppercase" data-i18n="cancel">CANCEL</button>
      </div>
    </div>
  </div>

  <div id="mini-modal" class="fixed inset-0 z-[300000] bg-black/80 backdrop-blur-md flex items-center justify-center p-6 hidden" onclick="this.classList.add('hidden')">
    <div id="mini-content" onclick="event.stopPropagation()"></div>
  </div>

  <div id="name-modal" class="fixed inset-0 z-[500000] bg-black/95 flex items-center justify-center p-6 hidden">
    <div class="w-full max-w-xs bg-zinc-900 p-8 rounded-[3rem] border border-white/10">
      <h2 class="text-[10px] font-black uppercase mb-6 text-white text-center" data-i18n="change_name">CHANGE NAME</h2>
      <input id="edit-name-in" data-i18n-ph="name" class="mb-6">
      <div class="grid grid-cols-2 gap-4">
        <button onclick="core.saveName()" class="bg-blue-600 py-4 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="save">SAVE</button>
        <button onclick="document.getElementById('name-modal').classList.add('hidden')" class="bg-white/5 py-4 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="cancel">CANCEL</button>
      </div>
    </div>
  </div>

  <div id="link-modal" class="fixed inset-0 z-[500000] bg-black/95 flex items-center justify-center p-6 hidden">
    <div class="w-full max-w-xs bg-zinc-900 p-8 rounded-[3rem] border border-white/10">
      <h2 class="text-[10px] font-black uppercase mb-6 text-white text-center" data-i18n="social_link">SOCIAL LINK</h2>
      <input id="link-label-in" data-i18n-ph="label" class="mb-4">
      <input id="link-url-in" placeholder="URL" class="mb-6">
      <div class="grid grid-cols-2 gap-4">
        <button onclick="core.saveLink()" class="bg-blue-600 py-4 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="save">SAVE</button>
        <button onclick="document.getElementById('link-modal').classList.add('hidden')" class="bg-white/5 py-4 rounded-2xl font-black text-[10px] uppercase text-white" data-i18n="cancel">CANCEL</button>
      </div>
    </div>
  </div>

  <div id="dm-modal" class="fixed inset-0 z-[400000] bg-black/95 flex items-center justify-center p-6 hidden">
    <div class="w-full max-lg bg-zinc-900 rounded-[3rem] border border-white/10 h-[600px] flex flex-col overflow-hidden">
      <div class="p-8 border-b border-white/5 flex justify-between items-center">
        <div>
          <div class="text-[8px] opacity-20 font-black uppercase mb-1">DM</div>
          <div id="dm-target-name" class="text-xl font-black italic uppercase text-blue-500">...</div>
        </div>
        <button onclick="document.getElementById('dm-modal').classList.add('hidden'); currentDmId = null;" class="text-xl opacity-30 text-white">×</button>
      </div>
      <div id="dm-box" class="flex-1 overflow-y-auto p-8 custom-scroll"></div>
      <input type="file" id="dm-file-input" class="hidden" onchange="core.sendDmFile(event)">
      <div class="p-8 bg-black/40 flex gap-3">
        <button onclick="document.getElementById('dm-file-input').click()" class="bg-white/5 px-4 rounded-2xl text-white/20 hover:text-blue-500 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.51a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <button id="voice-btn" class="bg-white/5 px-4 rounded-2xl text-white/20 hover:text-red-500 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        </button>
        <input id="dm-in" placeholder="..." onkeydown="if(event.key==='Enter')core.sendDm()">
        <button onclick="core.sendDm()" class="bg-blue-600 px-8 rounded-2xl font-black text-white flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        </button>
      </div>
    </div>
  </div>
</body>
          </html>
